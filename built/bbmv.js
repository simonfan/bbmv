//     bbmv
//     (c) simonfan
//     bbmv is licensed under the MIT terms.

define("bbmv/pipe/aux/general",["require","exports","module","lodash"],function(e,t){var i=e("lodash");t.buildPrefixRegExp=function(e){return e=i.isArray(e)?e:[e],new RegExp("^(?:"+e.join("|")+")([A-Z$_].*$)?")},t.lowercaseFirst=function(e){return e.charAt(0).toLowerCase()+e.slice(1)},t.uppercaseFirst=function(e){return e.charAt(0).toUpperCase()+e.slice(1)}}),define("bbmv/pipe/aux/parse-dest-str",["require","exports","module","lodash"],function(e,t,i){function r(e){var t=e.split(s),i=t.shift();return{method:i,args:t}}function n(e){var t=e.match(o),i=r(t[3]);return{format:t[1],selector:t[2],method:i.method,args:i.args}}var a=e("lodash"),s=/\s*:\s*/g;t.methodString=r;var o=/\s*(?:(.+?)\s*\|)?\s*(?:(.+?)\s*->)?\s*(.+)\s*/;i.exports=function(e){return a.map(e.split(/\s*,\s*/g),n)}}),define("bbmv/pipe/aux/extract-maps",["require","exports","module","jquery","lodash","bbmv/pipe/aux/general"],function(e,t,i){function r(e){return{"in":a.buildPrefixRegExp(e+"In"),out:a.buildPrefixRegExp(e+"Out"),dual:a.buildPrefixRegExp(e+"Dual"),reserved:a.buildPrefixRegExp(n.map(s,function(t){return e+t})),all:a.buildPrefixRegExp(e)}}var n=(e("jquery"),e("lodash")),a=e("bbmv/pipe/aux/general"),s=["Event","Scope"];i.exports=function(e,t){if(!t)throw new Error("[bbmv-pipe-extract-maps] No namespace defined for binding map extraction.");var i={"in":{},out:{},dual:{}},s=e.data(),o=r(t);return n.each(s,function(e,t){var r;(r=t.match(o.in))?(t=a.lowercaseFirst(r[1]),i.in[t]=e):(r=t.match(o.out))?(t=a.lowercaseFirst(r[1]),i.out[t]=e):(r=t.match(o.dual))?(t=a.lowercaseFirst(r[1]),i.dual[t]=e):!o.reserved.test(t)&&o.all.test(t)&&(r=t.match(o.all),t=a.lowercaseFirst(r[1]),i.dual[t]=e)}),i}}),define("bbmv/pipe/aux/index",["require","exports","module","lodash","bbmv/pipe/aux/general","bbmv/pipe/aux/parse-dest-str","bbmv/pipe/aux/extract-maps"],function(e,t){var i=e("lodash");i.assign(t,e("bbmv/pipe/aux/general")),t.parseDestStr=e("bbmv/pipe/aux/parse-dest-str"),t.extractMaps=e("bbmv/pipe/aux/extract-maps")}),define("bbmv/pipe/dest-get",["require","exports","module","jquery-value","lodash","bbmv/pipe/aux/index"],function(e,t){{var i=(e("jquery-value"),e("lodash"));e("bbmv/pipe/aux/index")}t.destGet=function(e,t){var r=this.bbmv,n=this.parseDestStr(t)[0],a=n.method,s=e[a]||r[a];if(!s)throw new Error("[bbmv|destGet] "+a+" could not be found.");e=n.selector?e.find(n.selector):e;var o=s.apply(e,n.args),p=n.format;if(p){var u=r[p];if(u=i.isFunction(u)?u:u["in"],!u)throw new Error("[bbmv|destGet] "+p+" could not be found.");o=u.call(r,o)}return o}}),define("bbmv/pipe/dest-set",["require","exports","module","jquery-value","lodash","bbmv/pipe/aux/index"],function(e,t){function i(e,t,i,n){var a=e.bbmv,s=i.format;if(s){var o=a[s];if(o=r.isFunction(o)?o:o.out,!o)throw new Error("[bbmv|destGet] "+s+" could not be found.");n=o.call(a,n)}var p=r.clone(i.args);p.push(n);var u=i.method,d=t[u]||a[u];if(!d)throw new Error("[bbmv|destSet] "+u+" could not be found.");return i.selector&&(t=t.find(i.selector)),d.apply(t,p)}{var r=(e("jquery-value"),e("lodash"));e("bbmv/pipe/aux/index")}t.destSet=function(e,t,n){var a=this.parseDestStr(t);r.each(a,function(t){return i(this,e,t,n)},this)}}),define("bbmv/pipe/index",["require","exports","module","pipe","lodash","bbmv/pipe/aux/index","bbmv/pipe/dest-get","bbmv/pipe/dest-set"],function(e,t,i){var r=e("pipe");_=e("lodash");var n=e("bbmv/pipe/aux/index"),a=r.prototype.to,s=(r.prototype.from,r.prototype.mapSingle,r.prototype.initialize),o={INPUT:"change",BUTTON:"click"},p=i.exports=r.extend({initialize:function(e,t,i,r){this._parsedDestStrs={},s.apply(this,_.toArray(arguments)),r=r||{},_.each(["namespace","bbmv"],function(e){this[e]=r[e]||this[e]},this)},parseDestStr:function(e){var t=this._parsedDestStrs[e];return t||(t=this._parsedDestStrs[e]=n.parseDestStr(e)),t},namespace:"bind",to:function(e){var t=this.namespace,i=n.extractMaps(e,t);this.map(i["in"],"from").map(i.out,"to").map(i.dual,"both");var r=e.data(t+"-event")||o[e.prop("tagName")];if(r){var s=_.union(_.keys(i["in"]),_.keys(i.dual));e.on(r,_.bind(function(){this.drain(s,{force:!0})},this))}return a.call(this,e)},srcGet:function(e,t){return e.get(t)},srcSet:function(e,t,i){return e.set(t,i)}});p.assignProto(e("bbmv/pipe/dest-get")).assignProto(e("bbmv/pipe/dest-set"))}),define("bbmv/aux",["require","exports","module","jquery-selector-data-prefix"],function(e,t){e("jquery-selector-data-prefix"),t.findBoundElements=function(e,t){var i=e.find(":data-prefix("+t+")");return e.add(i)}}),define("bbmv",["require","exports","module","lodash","jquery","lowercase-backbone","bbmv/pipe/index","bbmv/aux"],function(e,t,i){{var r=e("lodash"),n=e("jquery"),a=e("lowercase-backbone"),s=e("bbmv/pipe/index"),o=e("bbmv/aux");i.exports=a.view.extend({initialize:function(){a.view.prototype.initialize.apply(this,arguments),this.initializeModelView.apply(this,arguments)},initializeModelView:function(e){if(!this.model)throw new Error("No model set for model view.");if(!this.$el)throw new Error("No el set on model view.");this.pipes=[],r.each(["namespace","event"],function(t){this[t]=e[t]||this[t]},this);var t=o.findBoundElements(this.$el,this.namespace);r.each(t,function(e){this.pipe(n(e))},this),this.model.on(this.event,function(){this.pump()},this)},event:"change",namespace:"bind",mvPipe:s,pipe:function(e,t,i){i=i||{},i.namespace=i.namespace||this.namespace,i.bbmv=this;var r=s(this.model,e,t,i);return this.pipes.push(r),r},pump:function(){return r.each(this.pipes,function(e){e.pump()}),this},drain:function(){return r.each(this.pipes,function(e){e.drain()}),this}})}});